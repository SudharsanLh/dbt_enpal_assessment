{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.13", "generated_at": "2025-10-31T17:41:33.806763Z", "invocation_id": "225fd1c2-addb-46ef-9f01-ce546730afd8", "invocation_started_at": "2025-10-31T17:41:32.989208Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-10-31T17:41:33.680338Z", "completed_at": "2025-10-31T17:41:33.686802Z"}, {"name": "execute", "started_at": "2025-10-31T17:41:33.687005Z", "completed_at": "2025-10-31T17:41:33.794391Z"}], "thread_id": "Thread-1", "execution_time": 0.11483526229858398, "adapter_response": {"_message": "SELECT 1995", "code": "SELECT", "rows_affected": 1995}, "message": "SELECT 1995", "failures": null, "unique_id": "model.enpal_assessment_project.master_deal", "compiled": true, "compiled_code": "\n-- Get the current stage (most recent stage change)\nwith latest_stage as (\n    select\n        deal_id,\n        stage_id as current_stage_id,\n        stage_name as current_stage_name,\n        funnel_step as current_funnel_step,\n        change_time_at as latest_stage_change_at,\n        month as current_month,\n        row_number() over (partition by deal_id order by change_time_at desc) as rn\n    from \"postgres\".\"ods\".\"ods_deal_stage_journey\"\n),\nlatest_stage_final as (\n    select\n        deal_id,\n        current_stage_id,\n        current_stage_name,\n        current_funnel_step,\n        latest_stage_change_at,\n        current_month\n    from latest_stage\n    where rn = 1\n),\n-- Get the first stage (entry point into pipeline)\nfirst_stage as (\n    select\n        deal_id,\n        stage_id as first_stage_id,\n        stage_name as first_stage_name,\n        change_time_at as first_stage_entered_at,\n        month as month_entered_pipeline,\n        row_number() over (partition by deal_id order by change_time_at asc) as rn\n    from \"postgres\".\"ods\".\"ods_deal_stage_journey\"\n),\nfirst_stage_final as (\n    select\n        deal_id,\n        first_stage_id,\n        first_stage_name,\n        first_stage_entered_at,\n        month_entered_pipeline\n    from first_stage\n    where rn = 1\n),\n-- Get current owner (most recent user_id assignment)\nowner_extraction as (\n    select\n        deal_id,\n        cast(new_value as integer) as current_owner_id,\n        change_time_at,\n        row_number() over (partition by deal_id order by change_time_at desc) as rn\n    from \"postgres\".\"staging\".\"stg_deal_changes\"\n    where changed_field_key = 'user_id'\n        and new_value is not null\n),\ncurrent_owner as (\n    select\n        deal_id,\n        current_owner_id\n    from owner_extraction\n    where rn = 1\n),\n-- Get owner user details\nuser_details as (\n    select\n        user_id,\n        user_name,\n        user_email\n    from \"postgres\".\"staging\".\"stg_users\"\n),\n-- Aggregate all deal changes\ndeal_changes_summary as (\n    select\n        deal_id,\n        count(distinct changed_field_key) as total_field_changes,\n        max(change_time_at) as last_change_at,\n        min(change_time_at) as first_change_at\n    from \"postgres\".\"staging\".\"stg_deal_changes\"\n    where deal_id is not null\n    group by deal_id\n),\n-- Count owner reassignments (times deal was reassigned)\nowner_reassignments as (\n    select\n        deal_id,\n        count(distinct new_value) as times_reassigned\n    from \"postgres\".\"staging\".\"stg_deal_changes\"\n    where changed_field_key = 'user_id'\n        and new_value is not null\n    group by deal_id\n),\n-- Aggregate activities on the deal\nactivity_summary as (\n    select\n        deal_id,\n        count(distinct activity_id) as total_activities,\n        count(distinct case when is_completed then activity_id end) as completed_activities,\n        count(distinct case when is_funnel_tracked then activity_id end) as funnel_tracked_activities,\n        max(due_to) as last_activity_date,\n        count(distinct assigned_to_user) as unique_users_performed_activities\n    from \"postgres\".\"ods\".\"ods_deal_activity_funnel\"\n    where deal_id is not null\n    group by deal_id\n),\n-- Combine all metrics\nfinal_combined as (\n    select\n        ls.deal_id,       \n        -- Latest stage of the deal \n        ls.current_stage_id,\n        ls.current_stage_name,\n        ls.current_funnel_step,\n        ls.latest_stage_change_at,\n        ls.current_month,  \n        -- First stage of the deal \n        fs.first_stage_id,\n        fs.first_stage_name,\n        fs.first_stage_entered_at,\n        -- Current Owner\n        co.current_owner_id,\n        ud.user_name as current_owner_name,\n        ud.user_email as current_owner_email,\n        -- Deal Changes Summary\n        coalesce(dcs.total_field_changes, 0) as total_field_changes,\n        dcs.last_change_at as last_change_at,\n        dcs.first_change_at as first_change_at,\n        coalesce(ore.times_reassigned, 0) as times_reassigned, \n        -- Activity Summary\n        coalesce(act.total_activities, 0) as total_activities,\n        coalesce(act.completed_activities, 0) as completed_activities,\n        coalesce(act.funnel_tracked_activities, 0) as funnel_tracked_activities,\n        act.last_activity_date,\n        -- Derived Metrics\n        (current_date - ls.latest_stage_change_at::date)  as days_in_current_stage,\n       (current_date - fs.first_stage_entered_at::date)as days_in_pipeline\n    from latest_stage_final ls\n    left join first_stage_final fs on ls.deal_id = fs.deal_id\n    left join deal_changes_summary dcs on ls.deal_id = dcs.deal_id\n    left join owner_reassignments ore on ls.deal_id = ore.deal_id\n    left join activity_summary act on ls.deal_id = act.deal_id\n    left join current_owner co on ls.deal_id = co.deal_id\n    left join user_details ud on co.current_owner_id = ud.user_id\n)\nselect * from final_combined", "relation_name": "\"postgres\".\"ods\".\"master_deal\"", "batch_results": null}], "elapsed_time": 0.23900699615478516, "args": {"project_dir": "/Users/sudharsan/dbt_enpal_assessment", "favor_state": false, "require_batched_execution_for_custom_microbatch_strategy": false, "log_level": "info", "log_path": "/Users/sudharsan/dbt_enpal_assessment/logs", "partial_parse": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "empty": false, "show_resource_report": false, "select": ["master_deal"], "require_generic_test_arguments_property": true, "log_format_file": "debug", "version_check": true, "invocation_command": "dbt build -s master_deal", "require_nested_cumulative_type_params": false, "validate_macro_args": false, "source_freshness_run_project_hooks": true, "macro_debugging": false, "send_anonymous_usage_stats": true, "introspect": true, "log_file_max_bytes": 10485760, "log_level_file": "debug", "require_explicit_package_overrides_for_builtin_materializations": true, "skip_nodes_if_on_run_start_fails": false, "strict_mode": false, "require_resource_names_without_spaces": true, "resource_types": [], "require_all_warnings_handled_by_warn_error": false, "exclude_resource_types": [], "cache_selected_only": false, "exclude": [], "require_yaml_configuration_for_mf_time_spines": false, "state_modified_compare_more_unrendered_values": false, "defer": false, "state_modified_compare_vars": false, "populate_cache": true, "partial_parse_file_diff": true, "use_fast_test_edges": false, "upload_to_artifacts_ingest_api": false, "use_colors": true, "use_colors_file": true, "profiles_dir": "/Users/sudharsan/dbt_enpal_assessment", "write_json": true, "printer_width": 80, "static_parser": true, "export_saved_queries": false, "print": true, "indirect_selection": "eager", "show": false, "show_all_deprecations": false, "which": "build", "log_format": "default", "include_saved_query": false, "quiet": false, "vars": {}}}